<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>업무보고 자동검증기</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.css" />
    <style>
      body {
        background: linear-gradient(120deg, #e8edff 0%, #f7f7fa 100%);
        font-family: "Segoe UI", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
        margin: 0;
        min-height: 100vh;
      }
      .container {
        max-width: 850px;
        margin: 48px auto;
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 6px 32px #5165ff20, 0 2px 8px #0001;
        padding: 36px 30px 30px 30px;
        transition: box-shadow 0.2s;
        border: 1.5px solid #e6e8f0;
        position: relative;
      }
      h2 {
        text-align: left;
        font-weight: 700;
        font-size: 1.4rem;
        margin-bottom: 26px;
        color: #3049ff;
        letter-spacing: -1px;
      }
      .CodeMirror {
        border-radius: 13px;
        border: 1.5px solid #b5c6fa;
        box-shadow: 0 2px 8px #3049ff0d;
        background: #fafdff;
        font-size: 1.07rem;
        line-height: 1.75;
        min-height: 220px;
        width: 100%;
        margin-bottom: 22px;
        transition: border 0.16s;
      }
      .CodeMirror-focused {
        border: 1.8px solid #3654ff;
        background: #f4f8ff;
        outline: none;
      }
      button {
        width: 100%;
        margin: 10px 0 0 0;
        font-size: 1.18rem;
        font-weight: 600;
        background: linear-gradient(90deg, #3654ff 75%, #1c97e7 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 0;
        cursor: pointer;
        box-shadow: 0 2px 12px #3654ff24;
        transition: background 0.14s, box-shadow 0.17s, transform 0.14s;
        letter-spacing: 0.2px;
      }
      button:hover,
      button:focus {
        background: linear-gradient(90deg, #1c97e7 70%, #3654ff 100%);
        box-shadow: 0 3px 20px #1c97e74c;
        transform: translateY(-1px) scale(1.01);
      }
      .result {
        margin-top: 30px;
        min-height: 46px;
        animation: fadein 0.7s;
        padding: 22px 18px 15px 18px;
        border-radius: 12px;
        box-shadow: 0 2px 12px #3049ff10;
        font-size: 1.07rem;
      }
      .pass {
        color: #218938;
        background: #eaffed;
        border-left: 6px solid #36d173;
        font-weight: 700;
        padding-left: 7px;
      }
      .fail {
        color: #e02e2e;
        background: #fff3f3;
        border-left: 6px solid #ff5353;
        font-weight: 700;
        padding-left: 7px;
      }
      ul {
        line-height: 1.78;
        margin-top: 10px;
        margin-bottom: 0;
        padding-left: 20px;
      }
      @media (max-width: 1000px) {
        .container {
          max-width: 98vw;
          padding: 18px 3vw 30px 3vw;
        }
      }
      @keyframes fadein {
        0% {
          opacity: 0;
          transform: translateY(12px);
        }
        80% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .error-msg {
        padding: 8px 12px;
        margin: 4px 0;
        border-radius: 6px;
        transition: all 0.2s ease;
      }
      .error-msg:hover {
        background-color: #fff0f0;
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(255, 83, 83, 0.15);
      }
      /* 모달 스타일 */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        position: relative;
        background: white;
        margin: 50px auto;
        padding: 25px;
        width: 80%;
        max-width: 700px;
        border-radius: 15px;
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          transform: translateY(-100px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .close {
        position: absolute;
        right: 25px;
        top: 20px;
        font-size: 28px;
        cursor: pointer;
        color: #666;
      }

      .rule-list {
        margin-top: 20px;
      }

      .rule-list h4 {
        color: #3654ff;
        margin: 20px 0 10px 0;
      }

      .rule-list ul {
        margin: 10px 0;
        padding-left: 20px;
      }

      .rule-list li {
        margin: 8px 0;
        color: #444;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .button-group.help-group {
        position: absolute;
        top: 38px;
        right: 30px;
      }

      .help-btn {
        padding: 8px 16px;
        font-size: 0.95rem;
        color: #3654ff !important;
        background: #fff !important;
        border: 1.5px solid #3654ff !important;
        border-radius: 20px !important;
        width: auto !important;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }

      .help-btn:hover {
        background: #f4f8ff !important;
        transform: translateY(-1px);
        box-shadow: 0 3px 12px rgba(54, 84, 255, 0.15) !important;
      }

      .help-btn::before {
        content: "?";
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: #3654ff;
        color: white;
        border-radius: 50%;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .check-btn {
        width: 100%;
        margin: 22px 0 0 0;
        font-size: 1.18rem;
        font-weight: 600;
        background: linear-gradient(90deg, #3654ff 75%, #1c97e7 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 0;
        cursor: pointer;
        box-shadow: 0 2px 12px #3654ff24;
        transition: background 0.14s, box-shadow 0.17s, transform 0.14s;
        letter-spacing: 0.2px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>업무보고 자동검증기</h2>
      <div class="button-group help-group">
        <button id="helpBtn" class="help-btn">검증 규칙</button>
      </div>
      <textarea id="code" name="code">여기에 붙여넣으세요</textarea>
      <button id="checkBtn" class="check-btn">검증</button>
      <div id="result" class="result"></div>
    </div>

    <!-- 규칙 안내 모달 -->
    <div id="ruleModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>검증 규칙 안내</h3>
        <div class="rule-list">
          <h4>1. 공백 규칙</h4>
          <ul>
            <li>들여쓰기는 1칸 이상 금지</li>
            <li>콜론(:) 앞뒤 공백 금지</li>
            <li>꺾쇠(>) 앞뒤 공백 금지</li>
            <li>더하기(+) 앞뒤 반드시 공백 1칸</li>
            <li>콤마(,) 앞 공백 금지, 뒤 공백 1칸</li>
          </ul>
          <h4>2. 괄호 규칙</h4>
          <ul>
            <li>일반 괄호() 앞뒤/안쪽 공백 금지</li>
            <li>대괄호[] 앞뒤/안쪽 공백 금지</li>
            <li>날짜 표기는 (8/23), (~7/30) 형식만 허용</li>
          </ul>
          <h4>3. 분류 표기 규칙</h4>
          <ul>
            <li>대분류(1.) 뒤 공백 1칸</li>
            <li>대중분류((1)) 뒤 공백 1칸</li>
            <li>중분류(-) 뒤 공백 1칸</li>
            <li>소분류(․) 뒤 공백 1칸</li>
          </ul>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/mode/markdown/markdown.js"></script>
    <script>
      // CodeMirror 에디터 세팅
      var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        lineNumbers: true,
        mode: "markdown",
        lineWrapping: true,
      });

      // ▶️ 포커스 시 플레이스홀더 자동 삭제
      let clearedPlaceholder = false;
      editor.on("focus", function () {
        if (!clearedPlaceholder && editor.getValue().trim() === "여기에 붙여넣으세요") {
          editor.setValue("");
          clearedPlaceholder = true;
        }
      });

      // --- 업무보고 포맷 검증 메인 함수 ---
      function checkReportFormatting(text) {
        // 줄바꿈 통일 (\r\n -> \n) 후 라인별로 분리
        const lines = text.replace(/\r\n/g, "\n").split("\n");
        let errors = [];

        // --- 날짜 표기 검증 ---
        // 금지되는 날짜 패턴:
        // 1. 월/일이 0으로 시작 (예: 08/23, 8/05)
        // 2. "까지" 포함된 경우 (예: ~8/30까지)
        const forbiddenZeroOrUntilDate = /\(\~?((0\d{1}|[1-9]|1[0-2]))\/((0\d{1}|[1-9]|[12][0-9]|3[01]))(\s*까지)?\)/g;

        // --- 유틸리티 함수 정의 ---
        // 특정 위치의 라인 반환 (존재하지 않으면 빈 문자열)
        function getLine(idx, offset) {
          return lines[idx + offset] !== undefined ? lines[idx + offset] : "";
        }
        // 빈 줄 체크 (공백/탭만 있는 줄도 빈 줄로 처리)
        function isBlank(line) {
          return line.trim() === "";
        }
        // 중분류 라인 체크 (- 로 시작)
        function isMid(line) {
          return /^ *- /.test(line);
        }
        // 소분류 라인 체크 (․ 로 시작)
        function isLow(line) {
          return /^ *․ /.test(line);
        }
        // 대분류/대중분류 체크 (1. 또는 (1) 형태)
        function isSection(line) {
          return /^([1-9]\d*\.\s|\(\d+\)\s)/.test(line);
        }
        // 월 제목 체크 ([8월] 형태)
        function isMonth(line) {
          return /^\[[가-힣]+\]$/.test(line);
        }
        // 구분선 체크 (5개 이상의 -)
        function isSeparator(line) {
          return /^-{5,}$/.test(line);
        }

        // --- 날짜 표기 검증 로직 ---
        for (let i = 0; i < lines.length; i++) {
          let line = lines[i];
          let matches = line.match(forbiddenZeroOrUntilDate);
          if (matches) {
            for (let m of matches) {
              const dateContent = m.replace(/[()~]/g, "").replace(/\s/g, "");
              const [month, rest] = dateContent.split("/");
              const untilIncluded = m.includes("까지");
              
              // 날짜 형식 체크
              if ((month.length === 2 && month.startsWith("0")) || // 월이 0으로 시작
                  (rest.length > 1 && rest.startsWith("0")) ||     // 일이 0으로 시작
                  untilIncluded) {                                 // "까지" 포함
                errors.push(
                  `[${i + 1}행] 허용되지 않는 날짜 표기: ${m} (날짜는 (8/23), (~7/30) 형태만 허용, 월/일 0으로 시작·"까지" 포함은 금지)`
                );
              }
            }
          }
        }

        // --- 소분류(․) 상태 중복 체크 ---
        let idx = 0;
        while (idx < lines.length) {
          const line = lines[idx];
          if (isMid(line)) {
            // 중분류의 상태 추출 (완료/진행중/보류/취소/날짜)
            const midStateMatch = line.match(/(.+)\((완료|진행중|보류|취소|~?\d{1,2}\/\d{1,2})\)$/);
            const midState = midStateMatch ? midStateMatch[2] : null;

            // 연속된 소분류 블록 탐색 (빈 줄 허용)
            let lowList = [];
            let j = idx + 1;
            while (j < lines.length && (isLow(lines[j]) || isBlank(lines[j]))) {
              if (isLow(lines[j])) {
                let m = lines[j].match(/(.+)\((완료|진행중|보류|취소|~?\d{1,2}\/\d{1,2})\)$/);
                let state = m ? m[2] : null;
                lowList.push({ idx: j, state });
              }
              j++;
            }

            // 소분류들의 상태가 모두 동일한 경우 체크
            if (lowList.length > 1) {
              const allStates = lowList.map(x => x.state);
              const uniqueStates = [...new Set(allStates.filter(Boolean))];
              // 모든 소분류가 같은 상태면 중분류에만 상태 표시해야 함
              if (uniqueStates.length === 1 && uniqueStates[0] !== null && allStates.every(x => x)) {
                for (const low of lowList) {
                  if (low.state) {
                    errors.push(
                      `[${low.idx + 1}행] 소분류가 모두 같은 상태(${uniqueStates[0]})일 때는, 소분류에는 상태를 입력하지 마시고 중분류에만 상태를 입력하세요.`
                    );
                  }
                }
              }
            }
            idx = j;
            continue;
          }
          idx++;
        }

        // --- 공백 및 특수문자 규칙 검증 ---
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          // 1. 들여쓰기 검증 (2칸 이상 금지)
          if (!isBlank(line)) {
            if (/^\s{2,}/.test(line)) {
              errors.push(`[${i + 1}행] 들여쓰기는 1칸 이상 금지(불필요한 앞공백).`);
            }
          }

          // 2. 괄호/대괄호 공백 규칙
          let skipLeftBracketSpace = false;
          // 중분류/소분류의 시작 부분 괄호는 예외 처리
          if ((isMid(line) || isLow(line)) &&
              (line.match(/^ *- \(/) || line.match(/^ *- \[/) || 
               line.match(/^ *․ \(/) || line.match(/^ *․ \[/))) {
            skipLeftBracketSpace = true;
          }

          if (!isSection(line)) {
            // 좌측 공백+괄호 예외처리
            if (/( \(|\[ )/.test(line)) {
              if (!(skipLeftBracketSpace && (/( \(|\[ )/.test(line)))) {
                errors.push(`[${i + 1}행] ( ) 또는 [ ] 괄호/대괄호 양쪽에 공백이 있으면 안 됩니다.`);
              }
            }
            // 나머지 괄호 공백(오른쪽) 체크
            if (/(\(\s| \)|\)\s|\[\s| \]|\]\s)/.test(line)) {
              errors.push(`[${i + 1}행] ( ) 또는 [ ] 괄호/대괄호 양쪽에 공백이 있으면 안 됩니다.`);
            }
          }

          // 3. 특수문자 공백 규칙
          // >와 : 앞뒤 공백 금지
          if (/( [>:])|([>:] )/.test(line)) {
            errors.push(`[${i + 1}행] '>', ':' 기호의 앞뒤에 공백이 있으면 안 됩니다.`);
          }

          // 4. + 기호는 반드시 앞뒤 공백 1칸씩 필요
          if (/\S\+\S/.test(line) || /\+\+/.test(line)) {
            errors.push(`[${i + 1}행] '+' 기호는 반드시 앞뒤로 공백이 1칸씩 있어야 합니다.`);
          }
          if (/\+/.test(line)) {
            if (!/ (\+) /.test(line) && !/(^|\s)\+(\s|$)/.test(line)) {
              errors.push(`[${i + 1}행] '+' 기호는 반드시 앞뒤로 공백이 1칸씩 있어야 합니다.`);
            }
          }

          // 5. 콤마(,) 공백 규칙
          // 앞에 공백 금지, 뒤에 반드시 공백 1칸
          if (/\s,/.test(line)) {
            errors.push(`[${i + 1}행] ','의 앞에는 공백이 있으면 안 됩니다.`);
          }
          if (/,[^ ]/.test(line)) {
            errors.push(`[${i + 1}행] ','의 뒤에는 반드시 공백이 1칸 있어야 합니다.`);
          }
          if (/,\s{2,}/.test(line)) {
            errors.push(`[${i + 1}행] ','의 뒤에는 공백이 1칸만 있어야 합니다.`);
          }
        }
        return errors;
      }

      document.getElementById("checkBtn").onclick = function () {
        const input = editor.getValue();
        const resultDiv = document.getElementById("result");
        const errors = checkReportFormatting(input);

        if (errors.length === 0) {
          resultDiv.innerHTML = `<div class="pass">✅ 모든 항목이 규칙에 맞습니다. </div>`;
        } else {
          // 오류 메시지를 행 번호 순서대로 정렬
          const sortedErrors = errors.sort((a, b) => {
            const lineA = parseInt(a.match(/^\[(\d+)행\]/)[1]);
            const lineB = parseInt(b.match(/^\[(\d+)행\]/)[1]);
            return lineA - lineB;
          });

          resultDiv.innerHTML =
            `<div class="fail">❌ ${errors.length}건의 오류가 발견되었습니다.<br><ul style="list-style-type: none; padding-left: 0;">` +
            sortedErrors
              .map((msg) => {
                const match = msg.match(/^\[(\d+)행\]/);
                const lineNum = match ? parseInt(match[1], 10) : 1;
                return `<li class="error-msg" data-line="${lineNum}">
                    <span style="color: #ff5353; margin-right: 4px;">▶</span>
                    ${msg}
                  </li>`;
              })
              .join("") +
            "</ul></div>";

          // 오류 메시지 클릭 시 해당 행으로 이동
          document.querySelectorAll(".error-msg").forEach((el) => {
            el.style.cursor = "pointer";
            el.onclick = function () {
              const line = parseInt(this.getAttribute("data-line"), 10) - 1;
              editor.focus();
              editor.setCursor({ line, ch: 0 });
              editor.scrollIntoView({ line, ch: 0 }, 100);
            };
          });
        }
      };

      // 모달 관련 코드
      const modal = document.getElementById("ruleModal");
      const helpBtn = document.getElementById("helpBtn");
      const closeBtn = document.getElementsByClassName("close")[0];

      helpBtn.onclick = function () {
        modal.style.display = "block";
        document.body.style.overflow = "hidden"; // 배경 스크롤 방지
      };

      closeBtn.onclick = function () {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      };

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
        }
      };

      // ESC 키로 모달 닫기
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape" && modal.style.display === "block") {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
        }
      });
    </script>
  </body>
</html>
