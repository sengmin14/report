<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>업무보고 자동검증기</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.css" />
    <style>
      body { background: linear-gradient(120deg, #e8edff 0%, #f7f7fa 100%); font-family: "Segoe UI", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; margin: 0; min-height: 100vh; }
      .container { max-width: 850px; margin: 48px auto; background: #fff; border-radius: 22px; box-shadow: 0 6px 32px #5165ff20, 0 2px 8px #0001; padding: 36px 30px 30px 30px; transition: box-shadow 0.2s; border: 1.5px solid #e6e8f0; }
      h2 { text-align: left; font-weight: 700; font-size: 1.4rem; margin-bottom: 26px; color: #3049ff; letter-spacing: -1px; }
      .CodeMirror { border-radius: 13px; border: 1.5px solid #b5c6fa; box-shadow: 0 2px 8px #3049ff0d; background: #fafdff; font-size: 1.07rem; line-height: 1.75; min-height: 220px; width: 100%; margin-bottom: 22px; transition: border 0.16s; }
      .CodeMirror-focused { border: 1.8px solid #3654ff; background: #f4f8ff; outline: none; }
      button { width: 100%; margin: 10px 0 0 0; font-size: 1.18rem; font-weight: 600; background: linear-gradient(90deg, #3654ff 75%, #1c97e7 100%); color: #fff; border: none; border-radius: 8px; padding: 12px 0; cursor: pointer; box-shadow: 0 2px 12px #3654ff24; transition: background 0.14s, box-shadow 0.17s, transform 0.14s; letter-spacing: 0.2px; }
      button:hover, button:focus { background: linear-gradient(90deg, #1c97e7 70%, #3654ff 100%); box-shadow: 0 3px 20px #1c97e74c; transform: translateY(-1px) scale(1.01); }
      .result { margin-top: 30px; min-height: 46px; animation: fadein 0.7s; padding: 22px 18px 15px 18px; border-radius: 12px; box-shadow: 0 2px 12px #3049ff10; font-size: 1.07rem; }
      .pass { color: #218938; background: #eaffed; border-left: 6px solid #36d173; font-weight: 700; padding-left: 7px; }
      .fail { color: #e02e2e; background: #fff3f3; border-left: 6px solid #ff5353; font-weight: 700; padding-left: 7px; }
      ul { line-height: 1.78; margin-top: 10px; margin-bottom: 0; padding-left: 20px; }
      @media (max-width: 1000px) { .container { max-width: 98vw; padding: 18px 3vw 30px 3vw; } }
      @keyframes fadein { 0% { opacity: 0; transform: translateY(12px);} 80% { opacity: 0.7;} 100% { opacity: 1; transform: translateY(0);} }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>업무보고 자동검증기</h2>
      <textarea id="code" name="code">여기에 붙여넣으세요</textarea>
      <button id="checkBtn">검증</button>
      <div id="result" class="result"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/mode/markdown/markdown.js"></script>
    <script>
const utils = {
  getLine(lines, idx, offset) {
    return lines[idx + offset] !== undefined ? lines[idx + offset] : "";
  },
  isBlank(line) { 
    return line.trim() === ""; 
  },
  isMid(line) { 
    return /^ *- /.test(line); 
  },
  isLow(line) { 
    return /^ *․ /.test(line); 
  },
  isSection(line) { 
    return /^([1-9]\d*\.\s|\(\d+\)\s)/.test(line); 
  },
  isSeparator(line) { 
    return /^-{5,}$/.test(line); 
  },
  // 에러 메시지 생성 헬퍼
  formatError(lineNum, message) {
    return `[${lineNum}행] ${message}`;
  }
};

  // CodeMirror 에디터 세팅
  var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    lineNumbers: true,
    mode: "markdown",
    lineWrapping: true,
  });

  // ▶️ 포커스 시 플레이스홀더 자동 삭제
  let clearedPlaceholder = false;
  editor.on("focus", function () {
    if (!clearedPlaceholder && editor.getValue().trim() === "여기에 붙여넣으세요") {
      editor.setValue("");
      clearedPlaceholder = true;
    }
  });

  function checkReportFormatting(text) {
    const lines = text.replace(/\r\n/g, "\n").split("\n");
    let errors = [];

    function addError(lineNum, message) {
      errors.push(utils.formatError(lineNum, message));
    }

    // 날짜 형식 검증
    function checkDateFormat(line, lineNum) {
      // 1. 날짜 형식 정규식 - (8/7), (~8/7) 형식만 허용, "까지" 포함 체크
      const dateRegex = /\(~?(\d{1,2})\/(\d{1,2})(까지)?\)/g;
      let matches = line.match(dateRegex);
      
      if (matches) {
        matches.forEach(m => {
          // 2. "까지" 포함 여부 체크 - 먼저 검사
          if (m.includes("까지")) {
            addError(lineNum, `허용되지 않는 날짜 표기: ${m} ("까지" 포함은 금지)`);
            return; // 다음 검증은 건너뜀
          }

          const dateContent = m.replace(/[()~]/g, "");
          const [month, day] = dateContent.split("/");

          // 3. 월/일이 0으로 시작하는지 체크
          if (month.startsWith("0") || day.startsWith("0")) {
            addError(lineNum, `허용되지 않는 날짜 표기: ${m} (08/9, 8/09 같이 0으로 시작하는 월/일 표기는 금지)`);
          }

          // 4. 월/일 범위 체크
          const monthNum = parseInt(month);
          const dayNum = parseInt(day);
          
          if (monthNum < 1 || monthNum > 12) {
            addError(lineNum, `허용되지 않는 날짜 표기: ${m} (월은 1~12 사이여야 함)`);
          }
          
          if (dayNum < 1 || dayNum > 31) {
            addError(lineNum, `허용되지 않는 날짜 표기: ${m} (일은 1~31 사이여야 함)`);
          }
        });
      }
    }

    // 소분류 상태 검증
    function checkLowClassStatus(lines, startIdx) {
      if (!utils.isMid(lines[startIdx])) return startIdx + 1;

      const midStateMatch = lines[startIdx].match(/(.+)\((완료|진행중|보류|취소|~?\d{1,2}\/\d{1,2})\)$/);
      const midState = midStateMatch ? midStateMatch[2] : null;

      let lowList = [];
      let j = startIdx + 1;
      while (j < lines.length && (utils.isLow(lines[j]) || utils.isBlank(lines[j]))) {
        if (utils.isLow(lines[j])) {
          let m = lines[j].match(/(.+)\((완료|진행중|보류|취소|~?\d{1,2}\/\d{1,2})\)$/);
          let state = m ? m[2] : null;
          lowList.push({ idx: j, state });
        }
        j++;
      }

      if (lowList.length > 1) {
        const allStates = lowList.map(x => x.state);
        const uniqueStates = [...new Set(allStates.filter(Boolean))];
        if (uniqueStates.length === 1 && uniqueStates[0] !== null && allStates.every(x => x)) {
          lowList.forEach(low => {
            if (low.state) {
              addError(low.idx + 1, `소분류가 모두 같은 상태(${uniqueStates[0]})일 때는, 소분류에는 상태를 입력하지 마시고 중분류에만 상태를 입력하세요.`);
            }
          });
        }
      }
      return j;
    }

    // 공백 및 특수문자 검증 함수 추가
    function checkSpacingAndSymbols(line, lineNum) {
      if (!utils.isBlank(line)) {
        // 들여쓰기 검증
        if (/^\s{2,}/.test(line)) {
          addError(lineNum, "들여쓰기는 1칸 이상 금지(불필요한 앞공백).");
        }

        // 특수문자 공백 검증
        if ((/\s:/.test(line) || /:\s/.test(line)) || 
            (/ >/.test(line) || /> /.test(line))) {
          addError(lineNum, "'>', ':' 기호의 앞뒤에 공백이 있으면 안 됩니다.");
        }

        // + 기호 공백 검증
        if (/\S\+\S/.test(line) || /\+\+/.test(line) || 
            (/\+/.test(line) && !/ (\+) /.test(line) && !/(^|\s)\+(\s|$)/.test(line))) {
          addError(lineNum, "'+' 기호는 반드시 앞뒤로 공백이 1칸씩 있어야 합니다.");
        }

        // 괄호() 공백 검증
        if (/\s\(/.test(line) || /\)\s/.test(line) || /\(\s/.test(line) || /\s\)/.test(line)) {
          addError(lineNum, "'()', '[]' 기호의 앞뒤/안쪽에 공백이 있으면 안 됩니다.");
        }

        // [] 괄호 공백 검증
        if (/\s\[/.test(line) || /\]\s/.test(line) || /\[\s/.test(line) || /\s\]/.test(line)) {
          addError(lineNum, "'()', '[]' 기호의 앞뒤/안쪽에 공백이 있으면 안 됩니다.");
        }

        // 연속된 공백 검증
        if (/[^\n]\s{2,}[^\n]/.test(line)) {
          addError(lineNum, "연속된 공백은 허용되지 않습니다.");
        }

        // 문장 끝 공백 검증
        if (/\s$/.test(line)) {
          addError(lineNum, "문장 끝에 공백이 있으면 안 됩니다.");
        }

        // 콤마(,) 공백 검증
        if (/\s,/.test(line)) {
          addError(lineNum, "','의 앞에는 공백이 있으면 안 됩니다.");
        }
        if (/,[^ ]/.test(line)) {
          addError(lineNum, "','의 뒤에는 반드시 공백이 1칸 있어야 합니다.");
        }
        if (/,\s{2,}/.test(line)) {
          addError(lineNum, "','의 뒤에는 공백이 1칸만 있어야 합니다.");
        }
      }
    }

    // 분류 표기 공백 검증 함수 추가
    function checkClassificationSpacing(line, lineNum) {
      if (/^([1-9]\d*)\. ?/.test(line)) {
        const m = line.match(/^([1-9]\d*)\.(\s*)/);
        if (!m || m[2].length !== 1) {
          addError(lineNum, "대분류(1. 2. 등) 뒤에는 반드시 공백 1칸만 있어야 합니다.");
        }
      }

      if (/^\(\d+\)\s*/.test(line)) {
        const m = line.match(/^\(\d+\)(\s*)/);
        if (!m || m[1].length !== 1) {
          addError(lineNum, "대중분류((1) (2) 등) 뒤에는 반드시 공백 1칸만 있어야 합니다.");
        }
      }

      if ((/^-/.test(line) && !/^- /.test(line)) || /^-  /.test(line)) {
        addError(lineNum, "중분류(-) 뒤에는 반드시 공백 1칸이어야 합니다.");
      }

      if ((/^․/.test(line) && !/^․ /.test(line)) || /^․  /.test(line)) {
        addError(lineNum, "소분류(․) 뒤에는 반드시 공백 1칸이어야 합니다.");
      }
    }

    // 메인 검증 로직
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      checkDateFormat(line, i + 1);
      checkSpacingAndSymbols(line, i + 1);
      checkClassificationSpacing(line, i + 1);
      
      if (utils.isMid(line)) {  // utils.isMid 사용
        i = checkLowClassStatus(lines, i) - 1;
      }
    }

    return errors;
  }

      document.getElementById("checkBtn").onclick = function () {
        const input = editor.getValue();
        const resultDiv = document.getElementById("result");
        const errors = checkReportFormatting(input);

        if (errors.length === 0) {
          resultDiv.innerHTML = `<div class="pass">✅ 모든 항목이 규칙에 맞습니다. </div>`;
        } else {
          resultDiv.innerHTML =
            `<div class="fail">❌ ${errors.length}건의 오류가 발견되었습니다.<br><ul><li>` +
            errors.join("</li><li>") +
            "</li></ul></div>";
        }
      };
    </script>
  </body>
</html>
